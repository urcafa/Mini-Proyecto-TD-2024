---
title: "Mini Proyecto TD 2024"
subtitle: "Entrega parcial"
author: |
  Víctor Álvarez Palomares,  
  Sergio Martínez Yagüe,  
  Ferran Medina Mompó,  
  Carles Pascual i Sivera,  
  y Úrsula Casaus Fabra
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introducción

En esta primera parte de la entrega, vamos a importar y a analizar la información que nos aportan una serie de tickets de la compra que se nos proporcionan desde la asignatura.  

## Carga de librerías y datos necesarios para el análisis

Para empezar, se cargan todas las librerías necesarias para la realización del código. Esto se hace de manera más elegante utilizando el paquete pacman de RStudio. A continuación, se realiza la carga del conjunto de datos, los cuales se encuentran en formato .pdf. No obstante, no podemos importarlos desde este formato, así que vamos a convertirlos a .txt mediante una función que hemos creado en Python con la librería PyPDF2. De esta forma, obtenemos los ficheros .txt para poder importarlos en RStudio y trabajar con ellos.

## Características generales de los datos

Los datos de los tickets se van a encontrar en listas que contienen dos dataframes: por un lado, el primero contiene todos los productos excepto las frutas y contiene cuatro observaciones (producto, de tipo "char"; unidades, precio_completo y precio_individual, estos de tipo "num"); y por otro lado, un segundo dataframe que contiene los datos solo de las frutas y contiene cinco observaciones (frutas, de tipo "char"; precios, unidades, peso_kg y precio_por_kg, estos de tipo "num").

## Análisis de "missing data" en nuestro conjunto de interés

Por suerte, en nuestros conjuntos de datos no hay "missing data", ya que se tratan de tickets de la compra en los cuales cada producto tiene un nombre y precio asignados, y los tickets contienen la cantidad de veces que se añade a la compra. 

# Importación de los datos

Como ya hemos explicado previamente, hemos convertido nuestros ficheros a .txt desde .pdf. Ahora, vamos a crear otra función para separar las cadenas de caracteres de los ficheros y así importar los datos en los dataframes de forma que nos resulte más fácil trabajar con ellos. También hemos de crear un par de funciones que lean la fruta de forma correcta, pues el formato es distinto al resto de productos.

```{r}
# Primero que nada, cargamos las librerías:

library(pacman)
p_load(dplyr, stringr,ggplot2,tidyr)


extraer_informacion <- function(archivo) {
  # Leemos el texto desde el archivo
  texto <- readLines(archivo, encoding = "UTF-8")

  # Extraemos la fecha y la hora
  fecha_hora <- substr(texto[5], 1, 16)

  # Como esta información se encuentra en la misma línea de texto la separamos
  fecha <- substr(fecha_hora, 1, 10)
  hora <- substr(fecha_hora, 12, 16)

  # Extraemos la calle
  calle <- grep("C\\/\\s.*\\s\\d+", texto, value = TRUE)
  if (length(calle) == 0) {
    calle <- "Dirección no encontrada"
  }

  # Creamos el data frame
  df <- data.frame(Fecha = fecha, Hora = hora, Calle = calle)
  
  return(df)
}


```
```{r}
separar <- function(df) {
  df <- df %>%
    mutate(unidades = as.numeric(substr(producto, 1,1))) %>% 
    # Seleccionamos el número de unidades y hacemos una columna
    mutate(precio_completo =  (substr(producto, nchar(producto) - 3, nchar(producto))), 
           # Seleccionamos el precio y hacemos una columna
           producto = substr(producto, 2, nchar(producto)-4))
           # Borramos las unidades de la columna original
  
  df$precio_completo<- gsub(",", ".", df$precio_completo)
  df$precio_completo <- as.numeric(df$precio_completo)
  #Sustituyo comas por puntos y paso a numerico el precio
  
  df<- df %>% 
    mutate(precio_individual=precio_completo/unidades)
  #Obtengo el precio por unidad a partir del precio completo y las unidades
  
  return(df)
}
```




```{r}
arreglar_fruta <- function(fruta){
  
  # El argumento es un vector con varias frutas y su peso y precio
  
  precios <- fruta[seq_along(fruta) %% 2 == 0]  
  frutas <- fruta[seq_along(fruta) %% 2 != 0] 
  df <- data.frame(frutas = frutas,  precios = precios)
  # Separamos el vector en dos y creo un dataframe
  df <- df %>%
    mutate(unidades = as.numeric(substr(frutas, 1,1)),
           # Seleccionamos el número de unidades y hacemos una columna
           frutas = substr(frutas,2, nchar(frutas)),
           # Borramos el número de unidades de la columna
           peso_kg = substr(precios,1,nchar(precios)-20)) %>%
    # Obtenemos el peso de la columna precios y creamos una columna
    mutate(precio_por_kg = substr(precios,10,14)) %>%
    # Obtenemos el precio por kg de la columna precios y creamos una columna
    mutate(precios = substr(precios,nchar(precios)-4,nchar(precios)))
  # Seleccionamos únicamente el precio de la columna precios
  
  return(df)
}
```



```{r}
detectar_fruta <- function(a){
  texto <-  suppressWarnings(readLines(a, encoding = "windows-1252"))
  # Con UTF-8 daba error en algunos caracteres
  
  indice_parking <- grep("^1PARKING", texto)
  
  if (length(indice_parking) == 0) {
    productos <- texto[8:(length(texto) - 11)]
  } else {
    productos <- texto[8:(indice_parking - 1)]
  }
  # Seleccionamos solo las filas con productos y creamos un dataframe

  while (!grepl("^\\d", tail(productos, 1))) {
    productos <- productos[-length(productos)]
  }
  # Para asegurarnos de incluir todos los productos, seleccionamos líneas de más y 
  # borramos las sobrantes en este bucle
  
  df <- data.frame(producto = productos)
  
  indices <- c()

  for (i in productos){
    idx <- str_detect(i, "^[0-9]{1,3},[0-9]{3}")
    indices <- append(indices, idx)
    
  }
  ind_frut <- which(indices)
  # Detectamos  los índices de las frutas
  
  frutas <- c()
  for (i in ind_frut){
    frutas <- rbind(frutas, df[(i-1), ])
    frutas <- rbind(frutas, df[i, ])

  } 
  
  #Creamos un vector con las frutas y sus precios
  
  for (i in ind_frut){
    df <- subset(df, row.names(df) != i)
    df <- subset(df, row.names(df) != i-1)
  } 
  
  #Quitamos las frutas del dataframe
  
  df_productos<-separar(df)
  
  df_frutas<-arreglar_fruta(frutas)
  
  return(list(df_productos,df_frutas))
  
  # Devuelve un dataframe con producos y otro con las frutas

}

ticket_a <- detectar_fruta("./data/20231216 Mercadona 46,19.txt")
ticket_b <- detectar_fruta("./data/20231218 Mercadona 13,34.txt")
ticket_c <- detectar_fruta("./data/20231218 Mercadona 60,47.txt")
ticket_d <- detectar_fruta("./data/20231219 Mercadona 63,80.txt")
ticket_e <- detectar_fruta("./data/20231223 Mercadona 86,53.txt")
ticket_f <- detectar_fruta("./data/20231224 Mercadona 37,49.txt")
ticket_g <- detectar_fruta("./data/20231226 Mercadona 25,83.txt")
ticket_h <- detectar_fruta("./data/20231228 Mercadona 63,50.txt")
ticket_i <- detectar_fruta("./data/20231229 Mercadona 15,22.txt")
ticket_a
ticket_b
ticket_c
ticket_d
ticket_e
ticket_f
ticket_g
ticket_h
ticket_i

```


```{r}
print("a")
dfIVA <- function(listaArchivos) {
    dfl <- list()   
    
    for (archivo in listaArchivos) {
        texto <- suppressWarnings(readLines(archivo, encoding = "windows-1252"))
        total1 <- texto[grep("^TOTAL \\(", texto)]
        indice1 <- grep("^IVA BASE", texto)
        indice2 <- grep("^TOTAL \\d", texto)
        IVA <- texto[(indice1 + 1):(indice2 - 1)]
        IVA<- c(IVA,texto[indice2])
        matrizIVA <- matrix(IVA, ncol = 5, byrow = TRUE)
 
        dfIVA <- as.data.frame(matrizIVA)
         
        dfl[[archivo]] <- dfIVA
    }
     
    df_final<-bind_rows(dfl)
    df1 <- df_final %>%
  rowwise() %>%
  mutate(veintiuno = ifelse(any(startsWith(c_across(everything()), "21")), 
                   first(c_across(everything())[startsWith(c_across(everything()), "21")]), 
                   NA))%>%
    mutate(diez = ifelse(any(startsWith(c_across(everything()), "10")), 
                   first(c_across(everything())[startsWith(c_across(everything()), "10")]), 
                   NA))%>%
  mutate(cinco = ifelse(any(startsWith(c_across(everything()), "5")), 
                   first(c_across(everything())[startsWith(c_across(everything()), "5")]), 
                   NA))%>%
  mutate(cero = ifelse(any(startsWith(c_across(everything()), "0")), 
                   first(c_across(everything())[startsWith(c_across(everything()), "0")]), 
                   NA))%>%
  mutate(total = ifelse(any(startsWith(c_across(everything()), "TOTAL")), 
                   first(c_across(everything())[startsWith(c_across(everything()), "TOTAL")]), 
                   NA))
  df <-df1%>%
  select(veintiuno,diez,cinco,cero,total)%>%
  mutate(base21=substr(veintiuno,5,8))%>%
  mutate(base10=substr(diez,5,8))%>%
  mutate(base5=substr(cinco,4,8))%>%
  mutate(base0=substr(cero,4,8))%>%
  mutate(totalBase=substr(total,6,(nchar(total)-4)))%>%
  mutate(imponible21=substr(veintiuno,(nchar(veintiuno)-4),nchar(veintiuno)))%>%
  mutate(imponible10=substr(diez,(nchar(diez)-4),nchar(diez)))%>%
  mutate(imponible5=substr(cinco,(nchar(cinco)-4),nchar(cinco)))%>%
  mutate(imponible0=substr(cero,(nchar(cero)-4),nchar(cero)))%>%
  mutate(totalImponible=substr(total,(nchar(total)-4),nchar(total)))%>%
      select(base21,base10,base5,base0,imponible21,imponible10,imponible5,imponible0,totalBase,totalImponible) %>%
  mutate_all(~ str_replace_all(., ",", "."))%>%
   mutate_all(as.numeric)
    
    return(df)
}
carpeta <- "data"
fichero<-list.files(path = carpeta, full.names = TRUE, recursive = TRUE, pattern = ".txt")

a<-dfIVA(fichero)
a
 
```


```{r}
a %>%group_by()%>%
  summarise(s21= sum(imponible21, na.rm = TRUE),s10= sum(imponible10, na.rm = TRUE),s5= sum(imponible5, na.rm = TRUE),b21= sum(base21, na.rm = TRUE),b10= sum(base10, na.rm = TRUE),b5= sum(base5, na.rm = TRUE))

media_columnas <- colMeans(a, na.rm = TRUE)

print(media_columnas)

df_long <- gather(a, key = "Variable", value = "Valor")

ggplot(df_long, aes(x = Variable, y = Valor)) +
  geom_boxplot() +
  labs(title = "Boxplot de cada Variable", x = "Variable", y = "Valor")
```
```{r}

aGr<-a%>%
  select(base21,base10,base5,base0)
aGr<-gather(aGr, key = "Variable", value = "Valor")
        ggplot(data=aGr, aes(x=sqrt(Valor), fill=Variable)) +
               geom_density(alpha=.3)+
  scale_fill_manual(values = c("blue", "red", "green", "orange"))
        

        
        
        
aGr<-a%>%
  select(imponible21,imponible10,imponible5,imponible0)
aGr<-gather(aGr, key = "Variable", value = "Valor")
        ggplot(data=aGr, aes(x=sqrt(Valor), fill=Variable)) +
               geom_density(alpha=.3)+
  scale_fill_manual(values = c("purple", "yellow", "cyan", "green"))
```

```{r}
a1<-tail(a,1)
a1long <- gather(a1, key = "Variable", value = "Valor")

ggplot(a1long, aes(x = Variable, y = Valor, fill=Variable)) +
  geom_bar(stat = "identity") +  
  labs(title = "Gráfico de Barras", x = "Variable", y = "Valor") +  # Etiquetas del gráfico
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


  slice(a,1)
```


```{r}
lista <- list() 
carpeta <- "data"
#Creamos la lista de los ficheros
fichero<-list.files(path = carpeta, full.names = TRUE, recursive = TRUE, pattern = ".txt")
df <- as.data.frame(fichero)
for (i in (1:nrow(df))){
  lista[i] <- extraer_informacion(df$fichero[i])
  lista[i] <- detectar_fruta(df$fichero[i])
  print(lista[i])
} 
lista[1]

```


# Preguntas

A continuación vamos a plantearnos diferentes cuestiones que nos podrían venir a la cabeza a la hora de hacer un análisis de los tickets de la compra. 

1) ¿Qué productos son los más comprados? 
2) ¿Cuál es el gasto medio de cada compra?
3) ¿Qué nos podría dar a entender la frecuencia de compra de cada usuario
(compras diarias, semanales...)?
4) ¿Qué productos se compran más según el precio de la compra?
5) ¿Qué días hay compras más grandes?
6) ¿Qué productos tienen distintos tipos de IVA?
7) ¿Cuántos productos se compran de media en una compra?
8) ¿Hay algún patrón de compra según la estación del año?
9) ¿Qué productos cambian de precio (por kg)?

Además podríamos calcular las distribuciones de compras por categorías de productos para saber qué tipos de productos son los más comprados. A partir de esto también podríamos obtener la distribución de gastos que hace el consumidor a la hora de realizar la compra.

Asimismo, podríamos plantearnos otras cuestiones como el gasto medio de compra, si se hace el pago con efectivo o tarjeta o incluso si los usuarios tienden a ir en coche o a pie (depende de el tamaño de compra, o incluso comodidad).

