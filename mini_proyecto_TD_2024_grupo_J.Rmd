---
title: "Mini Proyecto TD 2024"
subtitle: "Entrega parcial"
author: |
  Víctor Álvarez Palomares,  
  Sergio Martínez Yagüe,  
  Ferran Medina Mompó,  
  Carles Pascual i Sivera,  
  y Úrsula Casaus Fabra
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introducción

En esta primera parte de la entrega, vamos a importar y a analizar la información que nos aportan una serie de tickets de la compra que se nos proporcionan desde la asignatura.

## Carga de librerías y datos necesarios para el análisis

Para empezar, se cargan todas las librerías necesarias para la realización del código. Esto se hace de manera más elegante utilizando el paquete pacman de RStudio. A continuación, se realiza la carga del conjunto de datos, los cuales se encuentran en formato .pdf. No obstante, no podemos importarlos desde este formato, así que vamos a convertirlos a .txt mediante una función que hemos creado en Python con la librería PyPDF2. De esta forma, obtenemos los ficheros .txt para poder importarlos en RStudio y trabajar con ellos.

```{r}
install_common_libraries <- function() {
  # Lista de librerías comunes
  common_libraries <- c(
    "ggplot2",
    "dplyr",
    "tidyr",
    "readr",
    "stringr",
    "ggplot2",
    "lubridate",
    "magrittr",
    "knitr",
    "shiny",
    "plotly")
  
  # Instalar las librerías
  for (lib in common_libraries) {
    if (!requireNamespace(lib, quietly = TRUE)) {
      install.packages(lib, dependencies = TRUE)
    }
  }
  
  print("Instalación completada.")
}

# Llama a la función para instalar las librerías comunes
install_common_libraries()
```

## Características generales de los datos

Los datos de los tickets se van a encontrar en listas que contienen dos dataframes: por un lado, el primero contiene todos los productos excepto las frutas y contiene cuatro observaciones (producto, de tipo "char"; unidades, precio_completo y precio_individual, estos de tipo "num"); y por otro lado, un segundo dataframe que contiene los datos solo de las frutas y contiene cinco observaciones (frutas, de tipo "char"; precios, unidades, peso_kg y precio_por_kg, estos de tipo "num").

## Análisis de "missing data" en nuestro conjunto de interés

Por suerte, en nuestros conjuntos de datos no hay "missing data", ya que se tratan de tickets de la compra en los cuales cada producto tiene un nombre y precio asignados, y los tickets contienen la cantidad de veces que se añade a la compra.

# Importación de los datos

Como ya hemos explicado previamente, hemos convertido nuestros ficheros a .txt desde .pdf. Ahora, vamos a crear otra función para separar las cadenas de caracteres de los ficheros y así importar los datos en los dataframes de forma que nos resulte más fácil trabajar con ellos. También hemos de crear un par de funciones que lean la fruta de forma correcta, pues el formato es distinto al resto de productos.

```{r}
# Primero que nada, cargamos las librerías:

library(pacman)
p_load(dplyr, stringr)
```

```{r message=FALSE, warning=FALSE}
# Crear un vector para almacenar los datos de los tickets
tickets <- list()

# Ruta a la carpeta que contiene los archivos txt
ruta_carpeta <- "./data/"

# Obtener la lista de archivos en la carpeta
archivos <- list.files(path = ruta_carpeta, pattern = ".txt", full.names = TRUE)

for (archivo in archivos) {
  # Leer el archivo txt
  # Leer el archivo txt y convertir a UTF-8
  lineas <- readLines(archivo, encoding = "latin1")
  lineas <- iconv(lineas, from = "latin1", to = "UTF-8", sub = "")
  
  # Otro código sigue igual

  
  # Extraer la información del ticket
  nombre <- lineas[1]
  direccion <- lineas[2]
  codigo_postal_municipio <- lineas[3]
  telefono <- lineas[4]
  fecha_operacion <- lineas[5]
  numero_factura <- lineas[6]
  cabeceras <- unlist(strsplit(lineas[7], "\t"))
  
  # Extraer la lista de productos
  productos <- lineas[8:(length(lineas) - 14)]
  # Eliminar espacios en blanco al principio y al final de cada línea
  productos <- trimws(productos)
  
  # Extraer el precio total
  precio_total <- lineas[length(lineas) - 12]
  
  # Extraer el método de pago e importe
  metodo_pago_importe <- lineas[length(lineas) - 11]
  
  # Extraer los tipos de IVA, base imponible y cuota
  iva <- lineas[(length(lineas) - 9):(length(lineas) - 6)]
  iva <- unlist(strsplit(iva, "\t"))
  
  # Extraer el sumatorio de la base imponible y de la cuota
  sumatorio_base_cuota <- lineas[length(lineas) - 5]
  
  # Extraer el número de tarjeta si ha sido el método de pago
  numero_tarjeta <- lineas[length(lineas) - 6]
  
  # Extraer información adicional
  informacion_adicional <- lineas[(length(lineas) - 4):length(lineas)]
  
 # Repetir el último valor para igualar la longitud de los vectores
longitud_deseada <- length(lineas)
repetir_ultimo_valor <- function(vector, longitud_deseada) {
  if (length(vector) < longitud_deseada) {
    ultimo_valor <- vector[length(vector)]
    nueva_longitud <- longitud_deseada - length(vector)
    vector_extendido <- c(vector, rep(ultimo_valor, nueva_longitud))
    return(vector_extendido)
  } else {
    return(vector)
  }
}

  # Almacenar la información en un data frame
  ticket_df <- data.frame(
    Nombre = repetir_ultimo_valor(nombre, longitud_deseada),
    Direccion = repetir_ultimo_valor(direccion, longitud_deseada),
    Codigo_Postal_Municipio = repetir_ultimo_valor(codigo_postal_municipio,                 longitud_deseada),
    Telefono = repetir_ultimo_valor(telefono, longitud_deseada),
    Fecha_Operacion = repetir_ultimo_valor(fecha_operacion, longitud_deseada),
    Numero_Factura = repetir_ultimo_valor(numero_factura, longitud_deseada),
    Cabeceras = repetir_ultimo_valor(cabeceras, longitud_deseada),
    Productos = repetir_ultimo_valor(productos, longitud_deseada),
    Precio_Total = repetir_ultimo_valor(precio_total, longitud_deseada),
    Metodo_Pago_Importe = repetir_ultimo_valor(metodo_pago_importe, longitud_deseada),
    IVA = repetir_ultimo_valor(iva, longitud_deseada),
    Sumatorio_Base_Cuota = repetir_ultimo_valor(sumatorio_base_cuota, longitud_deseada),
    Numero_Tarjeta = repetir_ultimo_valor(numero_tarjeta, longitud_deseada),
    Informacion_Adicional = repetir_ultimo_valor(informacion_adicional, longitud_deseada)
  )
  
    # Almacenar el dataframe del ticket en la lista de tickets
    tickets[[length(tickets) + 1]] <- ticket_df
  }
# Combinar todos los dataframes en uno solo
df_tickets <- do.call(rbind, tickets)
```

```{r message=FALSE, warning=FALSE}
library(tidyr)

# Convertir el dataframe en formato tidy
tidy_ticket <- df_tickets %>% separate(Telefono, into=c("X", "Telefono"), sep = " ") %>% separate(Codigo_Postal_Municipio, into = c("CP", "Municipio")) %>% separate(Fecha_Operacion, into = c("Fecha", "Hora"), sep = " ") %>% separate(Hora, into = c("Horas", "Mins"), sep = ":") %>% separate(Fecha, into = c("Dia", "Mes", "Anyo"), sep = "/") %>% separate(Numero_Factura, into = c("Y", "Cod_Factura"), sep = ":") %>% separate(Precio_Total, into = c("W", "Z","Importe"), sep = " ") %>% select(-c("X","Y","W","Z"))
# Ver el dataframe tidy

```

# Preguntas

A continuación vamos a plantearnos diferentes cuestiones que nos podrían venir a la cabeza a la hora de hacer un análisis de los tickets de la compra.

1)  ¿A qué hora del día se hacen más compras?

    ```{r warning=FALSE}
    library(ggplot2)
    compras_por_dia <- tidy_ticket %>% select(as.factor("Horas"))
    ggplot(data = compras_por_dia, aes(x = "Horas")) +
      geom_histogram(fill = "lightgreen", color = "black", bins = 30) +
      labs(title = "Horas con más compras", x = "Horas", y = "Frecuencia")
    ```

2)  ¿Qué días hay compras más grandes?

    ```{r warning=FALSE}

    ```

Además podríamos calcular las distribuciones de compras por categorías de productos para saber qué tipos de productos son los más comprados. A partir de esto también podríamos obtener la distribución de gastos que hace el consumidor a la hora de realizar la compra.

Asimismo, podríamos plantearnos otras cuestiones como el gasto medio de compra, si se hace el pago con efectivo o tarjeta o incluso si los usuarios tienden a ir en coche o a pie (depende de el tamaño de compra, o incluso comodidad).
